<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />

    <!-- Favicons -->
    <link
      rel="icon"
      href="/pelatihanmargono/backend/uploads/foto/LogoWeb.png"
      type="image/png"
      sizes="512x512"
    />

    <title>Admin - Kelola Pelatihan</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/main.css" />
  </head>
  <body>
    <!-- ================= NAVBAR ================= -->
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-accent bg-dark shadow-sm sticky-top"
    >
      <div class="container">
        <a
          class="navbar-brand fw-bold d-flex align-items-center gap-2"
          href="index.html"
        >
          <img
            src="/pelatihanmargono/backend/uploads/foto/LogoWeb.png"
            alt="Logo RSMS"
            style="height: 36px"
          />
          <span>ADMIN DIKLAT RSMS</span>
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#adminNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="adminNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                Pelatihan
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="pelatihan.html"
                    >Manajemen Pelatihan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="pendaftaran.html"
                    >Data Pendaftar</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="pembayaran.html"
                    >Verifikasi Pembayaran</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="kalender.html"
                    >Kalender Pelatihan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="kritiksaran.html"
                    >Kritik dan Saran</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="gallery.html">Gallery</a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                Tim & Mitra
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="fasilitator.html"
                    >Fasilitator</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="penyelenggara.html"
                    >Penyelenggara</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="institusi.html">Institusi</a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                Profil
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="institusipelatihan.html"
                    >Institusi Pelatihan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="timkerja.html">Tim Kerja</a>
                </li>
                <li>
                  <a class="dropdown-item" href="historiakreditasi.html"
                    >Histori Akreditasi</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="sertifikat.html">Sertifikat</a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                Organisasi
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="jabatan.html"
                    >Kelola Jabatan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="anggotaorganisasi.html"
                    >Kelola Anggota</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="strukturorganisasi.html"
                    >Struktur Organisasi</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
                >Admin
              </a>
              <ul class="dropdown-menu dropdown-menu-dark" id="menuSuperAdmin">
                <li>
                  <a class="dropdown-item" href="logadmin.html">Log Admin</a>
                </li>
                <!-- item superadmin akan ditambahkan lewat JS -->
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                id="namaAdmin"
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
                >Admin
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a
                    class="dropdown-item text-danger"
                    href="#"
                    onclick="logoutAdmin()"
                    >Logout</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- ===================== END NAVBAR ===================== -->

    <div class="container py-4">
      <h2 class="mb-4 fw-bold">üìö Kelola Pelatihan</h2>

      <!-- ==================== TABEL PELATIHAN ==================== -->
      <div class="card">
        <div class="card-header bg-dark text-white">Daftar Pelatihan</div>

        <!-- FILTER & EXPORT PELATIHAN -->
        <div class="row g-2 mb-2">
          <div class="col-md-2 mt-3 ms-3">
            <select id="filterStatusPelatihan" class="form-select">
              <option value="">Semua Status</option>
              <option value="draft">Draft</option>
              <option value="publish">Publish</option>
              <option value="selesai">Selesai</option>
              <option value="batal">Batal</option>
            </select>
          </div>

          <div class="col-md-3 mt-3">
            <select id="filterKategoriPelatihan" class="form-select">
              <option value="">Semua Kategori</option>
              <option value="Nakes">Nakes</option>
              <option value="Non-Nakes">Non-Nakes</option>
            </select>
          </div>

          <div class="col-md-2 mt-3">
            <select id="filterTahunPelatihan" class="form-select">
              <option value="">Semua Tahun</option>
              <option value="2023">2023</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </div>

          <div class="col-md-4 mt-3">
            <button class="btn btn-success" onclick="exportExcelPelatihan()">
              Export Excel Pelatihan
            </button>
          </div>
        </div>
        <!-- FILTER & EXPORT PELATIHAN -->

        <!-- SEARCH BAR -->
        <div class="col-md-4 mt-2 ms-3 mb-4 text-end">
          <i class="bi bi-search search-icon"></i>

          <input
            type="text"
            id="searchInput"
            placeholder="Cari Pelatihan..."
            class="form-control search-input ps-4"
          />
        </div>

        <div class="col-md-12">
          <button
            class="btn btn-primary mt-2 mb-2 ms-3"
            data-bs-toggle="modal"
            data-bs-target="#modalTambahPelatihan"
          >
            + Tambah Pelatihan
          </button>
        </div>

        <!-- TABLE CONTAINER (SCROLLABLE) -->
        <div
          class="table-responsive ms-3 me-3"
          style="max-height: 450px; overflow-y: auto"
        >
          <table class="table table-bordered table-hover table-sm mb-3">
            <thead class="thead-telur-asin">
              <tr>
                <th>No</th>
                <th>Nama Pelatihan</th>
                <th>JPL</th>
                <th>Lokasi</th>
                <th>Mulai</th>
                <th>Selesai</th>
                <th>Kuota</th>
                <th>Harga</th>
                <th>Kategori</th>
                <th>Kriteria Peserta</th>
                <th>Tipe Pelatihan</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tablePelatihan"></tbody>
          </table>
        </div>

        <!-- FOOTER PAGINATION -->
        <div
          class="card-footer d-flex justify-content-between align-items-center"
        >
          <div id="infoData" class="text-muted"></div>
          <div>
            <button class="btn btn-outline-secondary btn-sm" id="prevBtn">
              Previous
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="nextBtn">
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Tambah Pelatihan -->
    <div
      class="modal fade"
      id="modalTambahPelatihan"
      tabindex="-1"
      aria-labelledby="modalTambahPelatihanLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <!-- HEADER -->
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="modalTambahPelatihanLabel">
              Tambah Pelatihan Baru
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <!-- BODY -->
          <div class="modal-body">
            <form id="formTambahPelatihan">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nama Pelatihan *</label>
                  <input
                    type="text"
                    name="nama_pelatihan"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-12">
                  <label class="form-label">Jumlah JPL</label>
                  <input
                    type="number"
                    name="jumlah_jpl"
                    class="form-control"
                    min="0"
                    step="1"
                    value="0"
                  ></input>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Lokasi</label>
                  <input type="text" name="lokasi" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Alamat Lengkap</label>
                  <input
                    type="text"
                    name="alamat_lengkap"
                    class="form-control"
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Tanggal Mulai *</label>
                  <input
                    type="date"
                    name="tanggal_mulai"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Tanggal Selesai *</label>
                  <input
                    type="date"
                    name="tanggal_selesai"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Kuota Peserta</label>
                  <input
                    type="number"
                    name="kuota"
                    class="form-control"
                    min="0"
                    step="1"
                    value="0"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Warna di Kalender</label>
                  <input
                    type="color"
                    name="warna"
                    class="form-control form-control-color"
                    value="#3498db"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Harga Pelatihan (Rp)</label>
                  <input
                    type="number"
                    name="harga"
                    class="form-control"
                    min="0"
                    placeholder="Contoh: 250000"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Kategori Peserta</label>
                  <select name="kategori" class="form-control">
                    <option value="Nakes">Nakes</option>
                    <option value="Non Nakes">Non-Nakes</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Kriteria Peserta</label>
                  <input
                    type="text"
                    name="kriteria_peserta"
                    class="form-control"
                    placeholder="Contoh: Khusus nakes untuk Bidan, Dokter, dan Perawat"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Tipe Pelatihan</label>
                  <input
                    type="text"
                    name="tipe_pelatihan"
                    class="form-control"
                    placeholder="Online / Offline / Hybrid"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Durasi</label>
                  <input
                    type="text"
                    name="durasi"
                    class="form-control"
                    placeholder="Contoh: 3 Hari"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Status</label>
                  <select name="status" class="form-control">
                    <option value="draft">Draft</option>
                    <option value="publish">Publish</option>
                    <option value="selesai">Selesai</option>
                    <option value="batal">Batal</option>
                  </select>
                </div>

                <div class="col-md-12">
                  <label class="form-label">Upload Flyer</label>
                  <input
                    type="file"
                    name="flyer_url"
                    class="form-control"
                    accept="image/*"
                  />
                </div>
              </div>
            </form>
          </div>

          <!-- FOOTER -->
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Batal
            </button>
            <button class="btn btn-primary" form="formTambahPelatihan">
              + Tambah Pelatihan
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal End -->

    <!-- Modal Edit Pelatihan -->
    <div class="modal fade" id="modalEditPelatihan" tabindex="-1">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <!-- HEADER -->
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title">‚úèÔ∏è Edit Pelatihan</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <!-- BODY -->
          <div class="modal-body">
            <form id="formEditPelatihan" enctype="multipart/form-data">
              <input type="hidden" id="edit_id_pelatihan" />

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nama Pelatihan</label>
                  <input
                    id="edit_nama_pelatihan"
                    name="nama_pelatihan"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Jumlah JPL</label>
                  <input
                    id="edit_jumlah_jpl"
                    name="jumlah_jpl"
                    class="form-control"
                    type="number"
                    min="0"
                    step="1"
                    value="0"
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Lokasi</label>
                  <input id="edit_lokasi" name="lokasi" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Alamat Lengkap</label>
                  <input
                    id="edit_alamat_lengkap"
                    name="alamat_lengkap"
                    class="form-control"
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Tanggal Mulai</label>
                  <input
                    type="date"
                    id="edit_tanggal_mulai"
                    name="tanggal_mulai"
                    class="form-control"
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Tanggal Selesai</label>
                  <input
                    type="date"
                    id="edit_tanggal_selesai"
                    name="tanggal_selesai"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Kuota</label>
                  <input
                    type="number"
                    id="edit_kuota"
                    name="kuota"
                    class="form-control"
                    min="0"
                    step="1"
                    value="0"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Warna</label>
                  <input
                    type="color"
                    id="edit_warna"
                    name="warna"
                    class="form-control form-control-color"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Harga</label>
                  <input
                    type="number"
                    id="edit_harga"
                    name="harga"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Kategori</label>
                  <select
                    id="edit_kategori"
                    name="kategori"
                    class="form-control"
                  >
                    <option value="Nakes">Nakes</option>
                    <option value="Non Nakes">Non-Nakes</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Kriteria Peserta</label>
                  <input
                    id="edit_keterangan"
                    name="kriteria_peserta"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Tipe Pelatihan</label>
                  <input
                    id="edit_tipe_pelatihan"
                    name="tipe_pelatihan"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Durasi</label>
                  <input id="edit_durasi" name="durasi" class="form-control" />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Status</label>
                  <select id="edit_status" name="status" class="form-control">
                    <option value="draft">Draft</option>
                    <option value="publish">Publish</option>
                    <option value="selesai">Selesai</option>
                    <option value="batal">Batal</option>
                  </select>
                </div>

                <div class="col-md-12">
                  <p class="mt-2 mb-1 fw-bold">Preview Foto Saat Ini:</p>
                  <input
                    type="file"
                    id="edit_flyer_url"
                    name="flyer_url"
                    class="form-control"
                  />
                  <img
                    id="previewFlyer"
                    class="mt-2 border rounded"
                    width="150"
                    style="max-width: 180px; cursor: zoom-in"
                    onclick="zoomEditFoto()"
                  />
                </div>
              </div>
            </form>
          </div>

          <!-- FOOTER -->
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Batal
            </button>
            <button class="btn btn-primary" form="formEditPelatihan">
              Simpan Perubahan
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal End -->

    <!-- Modal Zoom Foto -->
    <div class="modal fade" id="modalZoomFoto" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
          <img id="zoomFotoImg" class="img-fluid rounded shadow" />
        </div>
      </div>
    </div>

    <!-- ========================== SCRIPT ========================== -->
    <script>
      // =========================
      // LOGOUT ADMIN (GLOBAL)
      // =========================
      async function logoutAdmin() {
        if (!confirm("Apakah Anda yakin ingin logout?")) return;

        try {
          await fetch("http://localhost:5000/api/admin/logout", {
            method: "POST",
            credentials: "include",
          });
        } catch (err) {
          console.error("Gagal logout:", err);
        } finally {
          localStorage.clear();
          window.location.href = "loginadmin.html";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const API = "http://localhost:5000/api/pelatihan";

        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 5;

        const tableBody = document.getElementById("tablePelatihan");
        const formTambah = document.getElementById("formTambahPelatihan");
        const formEdit = document.getElementById("formEditPelatihan");

        const filterStatus = document.getElementById("filterStatusPelatihan");
        const filterKategori = document.getElementById(
          "filterKategoriPelatihan"
        );
        const filterTahun = document.getElementById("filterTahunPelatihan");
        const infoData = document.getElementById("infoData");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const searchInput = document.getElementById("searchInput");

        // ================================
        // HEADER IDENTITAS ADMIN (WAJIB)
        // ================================
        const ADMIN_HEADERS = {
          "x-admin-id": localStorage.getItem("admin_id"),
          "x-admin-email": localStorage.getItem("admin_email"),
          "x-admin-nama": localStorage.getItem("admin_nama"),
        };

        // =========================
        // FORMAT TANGGAL & WAKTU
        // =========================
        function formatTanggal(tgl) {
          if (!tgl) return "-";
          const d = new Date(tgl);
          return d.toLocaleDateString("id-ID");
        }

        function formatWaktu(wkt) {
          if (!wkt) return "-";
          return wkt.substring(0, 5);
        }

        // =========================
        // FORMAT TANGGAL UNTUK INPUT <date>
        // =========================
        function formatForInput(dateString) {
          if (!dateString) return "";

          const d = new Date(dateString);
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");

          return `${year}-${month}-${day}`;
        }
        // =========================
        // LOAD DATA
        // =========================
        async function loadPelatihan() {
          try {
            const res = await fetch(API);
            const json = await res.json();

            allData = Array.isArray(json) ? json : [];
            filteredData = [...allData];
            currentPage = 1;

            renderTable();
          } catch (err) {
            console.error("Gagal load data:", err);
          }
        }
        // =========================
        // RENDER TABLE
        // =========================
        function renderTable() {
          tableBody.innerHTML = "";

          if (filteredData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                  <td colspan="9" class="text-center text-muted">
                    Data tidak ditemukan
                  </td>
                </tr>`;
            infoData.innerText = "Showing 0 entries";
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
          }

          const start = (currentPage - 1) * rowsPerPage;
          const end = start + rowsPerPage;
          const pageData = filteredData.slice(start, end);

          // =========================
          // LOAD DATA TABEL
          // =========================
          pageData.forEach((item, index) => {
            tableBody.innerHTML += `
              <tr>
                <td>${start + index + 1}</td>
                <td>${item.nama_pelatihan}</td>
                <td>${item.jumlah_jpl ?? "-"}</td>
                <td>${item.lokasi ?? "-"}</td>
                <td>${formatTanggal(item.tanggal_mulai)}</td>
                <td>${formatTanggal(item.tanggal_selesai)}</td>
                <td>${item.kuota ?? "-"}</td>
                <td>
                  ${
                    item.harga > 0
                      ? "Rp " + Number(item.harga).toLocaleString("id-ID")
                      : "Gratis"
                  }
                </td>
                <td>${item.kategori ?? "-"}</td>
                <td>${item.kriteria_peserta ?? "-"}</td>
                <td>${item.tipe_pelatihan ?? "-"}</td>
                <td>
                  <span class="badge bg-${
                    item.status === "publish"
                      ? "success"
                      : item.status === "draft"
                      ? "secondary"
                      : item.status === "selesai"
                      ? "primary"
                      : "danger"
                  }">${item.status}</span>
                </td>

                <td>
                  <button class="btn btn-warning btn-sm" onclick="openEditPelatihan(${
                    item.id_pelatihan
                  })">Edit</button>
                  <button class="btn btn-danger btn-sm" onclick="hapusPelatihan(${
                    item.id_pelatihan
                  })">Hapus</button>
                </td>
              </tr>
            `;
          });

          infoData.innerText = `Showing ${start + 1} to ${Math.min(
            end,
            filteredData.length
          )} of ${filteredData.length} entries`;

          prevBtn.disabled = currentPage === 1;
          nextBtn.disabled = end >= filteredData.length;
        }

        // ======================
        // PAGINATION BUTTON
        // ======================
        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderTable();
          }
        };

        nextBtn.onclick = () => {
          if (currentPage * rowsPerPage < filteredData.length) {
            currentPage++;
            renderTable();
          }
        };

        // ======================
        // SEARCH
        // ======================
        searchInput.addEventListener("keyup", () => {
          const keyword = searchInput.value.toLowerCase();
          filteredData = allData.filter((item) =>
            item.nama_pelatihan.toLowerCase().includes(keyword)
          );
          currentPage = 1;
          renderTable();
        });

        // =========================
        // CREATE: TAMBAH DATA
        // =========================
        if (formTambah) {
          formTambah.addEventListener("submit", async (e) => {
            e.preventDefault();

            const tanggalMulai = new Date(
              formTambah.querySelector("[name='tanggal_mulai']").value
            );
            const tanggalSelesai = new Date(
              formTambah.querySelector("[name='tanggal_selesai']").value
            );

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            tanggalMulai.setHours(0, 0, 0, 0);
            tanggalSelesai.setHours(0, 0, 0, 0);

            if (tanggalMulai < today) {
              alert("‚ùå Tanggal mulai tidak boleh sebelum hari ini");
              return;
            }

            if (tanggalSelesai < tanggalMulai) {
              alert(
                "‚ùå Tanggal selesai tidak boleh lebih awal dari tanggal mulai"
              );
              return;
            }

            const formData = new FormData(formTambah);

            // jika ingin set created_by admin tertentu ‚Üí misal 1
            const res = await fetch(API, {
              method: "POST",
              headers: ADMIN_HEADERS,
              body: formData,
            });

            const data = await res.json();

            alert(data.message);

            if (res.ok) {
              formTambah.reset();
              loadPelatihan();

              const modalEl = document.getElementById("modalTambahPelatihan");
              const modal = bootstrap.Modal.getInstance(modalEl);
              modal.hide();
            }
          });
        }

        // ======================
        // FILTER
        // ======================
        function applyFilterPelatihan() {
          filteredData = [...allData];

          if (filterStatus.value) {
            filteredData = filteredData.filter(
              (d) => d.status === filterStatus.value
            );
          }

          if (filterKategori.value) {
            filteredData = filteredData.filter(
              (d) => d.kategori === filterKategori.value
            );
          }

          if (filterTahun.value) {
            filteredData = filteredData.filter((d) => {
              return (
                new Date(d.tanggal_mulai).getFullYear() == filterTahun.value
              );
            });
          }

          currentPage = 1;
          renderTable();
        }

        // EVENT LISTENER AUTO REFRESH
        filterStatus?.addEventListener("change", applyFilterPelatihan);
        filterKategori?.addEventListener("change", applyFilterPelatihan);
        filterTahun?.addEventListener("change", applyFilterPelatihan);

        // ==========================================
        // EXPORT EXCEL (FILTERED) ‚úÖ
        // ==========================================
        window.exportExcelPelatihan = () => {
          const params = new URLSearchParams();

          if (filterStatus?.value) params.append("status", filterStatus.value);
          if (filterKategori?.value)
            params.append("kategori", filterKategori.value);
          if (filterTahun?.value) params.append("tahun", filterTahun.value);

          const url = `${API}/export/excel?${params.toString()}`;
          window.open(url, "_blank");
        };

        /* =========================
            EDIT (MODAL)
          ========================= */
        window.openEditPelatihan = async (id) => {
          const res = await fetch(`${API}/${id}`);
          if (!res.ok) {
            throw new Error("Gagal mengambil data pelatihan");
          }
          const data = await res.json();

          edit_id_pelatihan.value = data.id_pelatihan;
          edit_nama_pelatihan.value = data.nama_pelatihan;
          edit_jumlah_jpl.value = data.jumlah_jpl ?? "";
          edit_lokasi.value = data.lokasi ?? "";
          edit_alamat_lengkap.value = data.alamat_lengkap ?? "";
          edit_tanggal_mulai.value = formatForInput(data.tanggal_mulai);
          edit_tanggal_selesai.value = formatForInput(data.tanggal_selesai);
          edit_kuota.value = data.kuota ?? "";
          edit_warna.value = data.warna ?? "#3498db";
          edit_harga.value = data.harga ?? 0;
          edit_kategori.value = data.kategori;
          edit_keterangan.value = data.kriteria_peserta ?? "";
          edit_tipe_pelatihan.value = data.tipe_pelatihan ?? "";
          edit_durasi.value = data.durasi ?? "";
          edit_status.value = data.status;

          previewFlyer.src = data.flyer_url
            ? `http://localhost:5000/uploads/flyer/${data.flyer_url}`
            : "";

          new bootstrap.Modal(
            document.getElementById("modalEditPelatihan")
          ).show();
        };

        /* =========================
            SUBMIT EDIT
          ========================= */
        if (formEdit) {
          formEdit.addEventListener("submit", async (e) => {
            e.preventDefault();

            const id = edit_id_pelatihan.value;
            const formData = new FormData(formEdit);

            const res = await fetch(`${API}/${id}`, {
              method: "PUT",
              headers: ADMIN_HEADERS,
              body: formData,
            });

            const result = await res.json();
            alert(result.message);

            bootstrap.Modal.getInstance(
              document.getElementById("modalEditPelatihan")
            ).hide();

            loadPelatihan();
          });
        }

        // =========================
        // ZOOM FOTO EDIT
        // =========================
        window.zoomEditFoto = () => {
          const src = document.getElementById("previewFlyer").src;
          document.getElementById("zoomFotoImg").src = src;

          new bootstrap.Modal(document.getElementById("modalZoomFoto")).show();
        };

        // =========================
        // DELETE DATA
        // =========================
        window.hapusPelatihan = async (id) => {
          if (!confirm("Yakin ingin menghapus pelatihan ini?")) return;

          const res = await fetch(`${API}/${id}`, { 
            method: "DELETE",
            headers: ADMIN_HEADERS, });
            
          const data = await res.json();

          alert(data.message);
          loadPelatihan();
        };

        loadPelatihan();
      });

      // logout admin
      function logoutAdmin() {
        if (!confirm("Yakin ingin logout?")) return;

        // Hapus data admin
        localStorage.removeItem("admin_id");
        localStorage.removeItem("admin_email");
        localStorage.removeItem("admin_nama");

        // Redirect ke halaman login admin
        window.location.href =
          "/pelatihanmargono/frontend/admin/loginadmin.html";
      }
    </script>

    <script src="admin_guard.js"></script>
    <script src="admin_nav_role.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

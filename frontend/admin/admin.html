<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <!-- Favicons -->
    <link
      rel="icon"
      href="/pelatihanmargono/backend/uploads/foto/LogoWeb.png"
      type="image/png"
      sizes="512x512"
    />

    <title>Admin - Kelola User Admin</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    
    <link rel="stylesheet" href="../assets/css/main.css" />

    <style>
      body {
        background: #f5f6fa;
      }
      .card {
        border-radius: 10px;
      }
    </style>
  </head>

  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-accent bg-dark shadow-sm sticky-top"
    >
      <div class="container">
        <a
          class="navbar-brand fw-bold d-flex align-items-center gap-2"
          href="index.html"
        >
          <img
            src="/pelatihanmargono/backend/uploads/foto/LogoWeb.png"
            alt="Logo RSMS"
            style="height: 36px"
          />
          <span>ADMIN DIKLAT RSMS</span>
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#adminNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="adminNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                Pelatihan
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="pelatihan.html"
                    >Manajemen Pelatihan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="pendaftaran.html"
                    >Data Pendaftar</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="pembayaran.html"
                    >Verifikasi Pembayaran</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="kalender.html"
                    >Kalender Pelatihan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="kritiksaran.html"
                    >Kritik dan Saran</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="gallery.html">Gallery</a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                Tim & Mitra
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="fasilitator.html"
                    >Fasilitator</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="penyelenggara.html"
                    >Penyelenggara</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="institusi.html">Institusi</a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                Profil
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="institusipelatihan.html"
                    >Institusi Pelatihan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="timkerja.html">Tim Kerja</a>
                </li>
                <li>
                  <a class="dropdown-item" href="historiakreditasi.html"
                    >Histori Akreditasi</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="sertifikat.html">Sertifikat</a>
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
              >
                Organisasi
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="jabatan.html"
                    >Kelola Jabatan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="anggotaorganisasi.html"
                    >Kelola Anggota</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="strukturorganisasi.html"
                    >Struktur Organisasi</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
                >Admin
              </a>
              <ul class="dropdown-menu dropdown-menu-dark" id="menuSuperAdmin">
                <li>
                  <a class="dropdown-item" href="logadmin.html">Log Admin</a>
                </li>
                <li>
                  <a class="dropdown-item" href="logemail.html">Log Email</a>
                </li>
                <!-- item superadmin akan ditambahkan lewat JS -->
              </ul>
            </li>

            <li class="nav-item dropdown">
              <a
                id="namaAdmin"
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
                >Admin
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a
                    class="dropdown-item text-danger"
                    href="#"
                    onclick="logoutAdmin()"
                    >Logout</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container py-4">
      <h2 class="fw-bold mb-4">ðŸ‘‘ Kelola User Admin</h2>

      <div class="card">
        <div class="card-header bg-dark text-white">Daftar Admin</div>

        <div class="row mt-3 ms-3 me-3">
          <div class="col-md-4">
            <input
              type="text"
              id="searchAdmin"
              class="form-control"
              placeholder="Cari admin..."
            />
          </div>

          <div class="col-md-8 text-end" id="btnTambahContainer">
            <!-- tombol hanya muncul jika super admin -->
          </div>
        </div>

        <div class="table-responsive mt-3 ms-3 me-3" style="max-height: 450px">
          <table class="table table-bordered table-hover table-sm">
            <thead class="thead-telur-asin">
              <tr>
                <th>No</th>
                <th>Nama Lengkap</th>
                <th>Email</th>
                <th>Level</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tableAdmin"></tbody>
          </table>
        </div>

        <div class="card-footer d-flex justify-content-between">
          <div id="infoData"></div>
          <div>
            <button class="btn btn-outline-secondary btn-sm" id="prevBtn">
              Previous
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="nextBtn">
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL TAMBAH ADMIN -->
    <div class="modal fade" id="modalTambahAdmin">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title">Tambah Admin</h5>
            <button
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <form id="formAdmin">
              <div class="mb-3">
                <label>Nama Lengkap</label>
                <input
                  type="text"
                  name="nama_lengkap"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label>Email</label>
                <input
                  type="email"
                  name="email"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label>Password</label>
                <input
                  type="password"
                  id="password"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label>Konfirmasi Password</label>
                <input
                  type="password"
                  id="confirmPassword"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label>Level</label>
                <select name="level_user" class="form-control">
                  <option value="1">Super Admin</option>
                  <option value="2">Admin</option>
                </select>
              </div>

              <div class="mb-3">
                <label>Status</label>
                <select name="status_user" class="form-control">
                  <option value="1">Aktif</option>
                  <option value="0">Nonaktif</option>
                </select>
              </div>
            </form>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Batal
            </button>
            <button type="submit" form="formAdmin" class="btn btn-primary">
              Simpan
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function logoutAdmin() {
        if (!confirm("Apakah Anda yakin ingin logout?")) return;

        try {
          await fetch("http://localhost:5000/api/admin/logout", {
            method: "POST",
            credentials: "include",
          });
        } catch (err) {
          console.error("Gagal logout:", err);
        } finally {
          window.location.href = "loginadmin.html";
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const API = "http://localhost:5000/api/admin";
        const tableBody = document.getElementById("tableAdmin");
        const searchInput = document.getElementById("searchAdmin");
        const infoData = document.getElementById("infoData");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 5;
        let currentUser = null;

        // ===============================
        // Format Tangal
        // ===============================
        function formatTanggal(waktu) {
          if (!waktu) return "-";

          const date = new Date(waktu);

          const hari = String(date.getDate()).padStart(2, "0");
          const bulan = String(date.getMonth() + 1).padStart(2, "0");
          const tahun = date.getFullYear();

          const jam = String(date.getHours()).padStart(2, "0");
          const menit = String(date.getMinutes()).padStart(2, "0");
          const detik = String(date.getSeconds()).padStart(2, "0");

          return `${hari}/${bulan}/${tahun} ${jam}:${menit}:${detik}`;
        }

        // Render Button Aksi Aktif dan Nonaktif
        function renderStatusButton(item) {
          if (!currentUser || Number(currentUser.level_user) !== 1) {
            return "-";
          }

          if (item.status_user == 1) {
            return `
            <button class="btn btn-danger btn-sm"
                onclick="toggleStatus(${item.id_user}, ${item.status_user}, '${item.nama_lengkap}')">
                Nonaktifkan
            </button>
            `;
          }

          return `
            <button class="btn btn-success btn-sm"
            onclick="toggleStatus(${item.id_user}, ${item.status_user})">
            Aktifkan
            </button>
        `;
        }

        // ===============================
        // CEK LOGIN ADMIN
        // ===============================
        const meRes = await fetch(API + "/me", { credentials: "include" });
        const meData = await meRes.json();

        currentUser = meData.admin;

        // Menu khusus superadmin
        // const menuSuperAdmin = document.getElementById("menuSuperAdmin");

        // if (currentUser?.level_user === 1) {
        //   menuSuperAdmin.innerHTML = `
        //     <li>
        //     <a class="dropdown-item" href="admin.html">Kelola Admin</a>
        //     </li>
        // `;
        // } else {
        //   menuSuperAdmin.innerHTML = ""; // kosongkan jika bukan super admin
        // }

        // console.log("RESPONSE /me:", meData);
        // console.log("CURRENT USER:", currentUser);

        if (currentUser?.level_user === 1) {
          document.getElementById("btnTambahContainer").innerHTML = `
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTambahAdmin">
            + Tambah Admin
        </button>
        `;
        }

        // ===============================
        // LOAD DATA
        // ===============================
        async function loadAdmin() {
          const res = await fetch(API, { credentials: "include" });

          if (!res.ok) {
            alert("Anda tidak memiliki akses atau belum login");
            return;
          }

          const data = await res.json();

          if (!Array.isArray(data)) {
            console.error("Data bukan array:", data);
            allData = [];
          } else {
            allData = data;
          }

          applyFilter();
        }

        function applyFilter() {
          const keyword = searchInput.value.toLowerCase();
          filteredData = allData.filter(
            (item) =>
              item.nama_lengkap.toLowerCase().includes(keyword) ||
              item.email.toLowerCase().includes(keyword),
          );
          currentPage = 1;
          renderTable();
        }

        function renderTable() {
          tableBody.innerHTML = "";

          if (filteredData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center">Data tidak ada</td></tr>`;
            return;
          }

          const start = (currentPage - 1) * rowsPerPage;
          const end = start + rowsPerPage;
          const pageData = filteredData.slice(start, end);

          pageData.forEach((item, index) => {
            tableBody.innerHTML += `
        <tr>
          <td>${start + index + 1}</td>
          <td>${item.nama_lengkap}</td>
          <td>${item.email}</td>
          <td>${item.level_user == 1 ? "Super Admin" : "Admin"}</td>
          <td>
            <span class="badge bg-${item.status_user == 1 ? "success" : "secondary"}">
              ${item.status_user == 1 ? "Aktif" : "Nonaktif"}
            </span>
          </td>
          <td>${formatTanggal(item.last_login)}</td>
          <td>${renderStatusButton(item)}</td>
        </tr>
      `;
          });

          infoData.innerText = `Showing ${start + 1} to ${Math.min(end, filteredData.length)} of ${filteredData.length}`;
          prevBtn.disabled = currentPage === 1;
          nextBtn.disabled = end >= filteredData.length;
        }

        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderTable();
          }
        };
        nextBtn.onclick = () => {
          if (currentPage * rowsPerPage < filteredData.length) {
            currentPage++;
            renderTable();
          }
        };
        searchInput.addEventListener("input", applyFilter);

        // ===============================
        // CREATE ADMIN
        // ===============================
        document
          .getElementById("formAdmin")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const password = document.getElementById("password").value;
            const confirm = document.getElementById("confirmPassword").value;

            if (password !== confirm) {
              alert("Password tidak cocok");
              return;
            }

            const formData = new FormData(e.target);
            formData.append("password", password);

            const res = await fetch(API, {
              method: "POST",
              body: JSON.stringify(Object.fromEntries(formData)),
              headers: { "Content-Type": "application/json" },
              credentials: "include",
            });

            const data = await res.json();
            alert(data.message);

            if (res.ok) {
              bootstrap.Modal.getInstance(
                document.getElementById("modalTambahAdmin"),
              ).hide();
              e.target.reset();
              loadAdmin();
            }
          });

        window.toggleStatus = async (id, status, nama_lengkap) => {
          const action = status == 1 ? "menonaktifkan" : "mengaktifkan";

          const confirmAction = confirm(
            `Apakah Anda yakin ingin ${action} ${nama_lengkap}?`,
          );

          if (!confirmAction) return;

          const res = await fetch(`${API}/${id}/status`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status_user: status == 1 ? 0 : 1 }),
            credentials: "include",
          });

          const data = await res.json();

          if (!res.ok) {
            alert(data.message || "Gagal mengubah status");
            return;
          }

          alert(data.message);
          loadAdmin();
        };

        loadAdmin();
      });
    </script>

    <script src="admin_guard.js"></script>
    <script src="admin_nav_role.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

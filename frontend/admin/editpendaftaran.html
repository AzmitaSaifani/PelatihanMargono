<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Edit Pendaftaran Peserta</title>

    <!-- PROTEKSI LOGIN ADMIN -->
    <script>
      const admin = localStorage.getItem("admin");
      if (!admin) {
        window.location.href = "loginadmin.html";
      }
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/main.css" />

    <style>
      body {
        background: #f5f6fa;
      }
      .card {
        border-radius: 10px;
      }
      .thumb-img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 6px;
      }
    </style>
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">Admin DIKLAT</a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#adminNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="adminNav">
          <ul class="navbar-nav ms-auto">
            <!-- Pelatihan -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
                >Pelatihan</a
              >
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="pelatihan.html"
                    >Manajemen Pelatihan</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="pendaftaran.html"
                    >Data Pendaftaran</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="pembayaran.html"
                    >Verifikasi Pembayaran</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="gallery.html"
                    >Gallery Diklat</a
                  >
                </li>
              </ul>
            </li>

            <!-- Tim & Mitra -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                data-bs-toggle="dropdown"
                >Tim & Mitra</a
              >
              <ul class="dropdown-menu dropdown-menu-dark">
                <li>
                  <a class="dropdown-item" href="fasilitator.html"
                    >Fasilitator</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="penyelenggara.html"
                    >Penyelenggara</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="institusi.html"
                    >Institusi Kerjasama</a
                  >
                </li>
              </ul>
            </li>

            <li class="nav-item">
              <a class="nav-link text-danger fw-bold" href="logout.html"
                >Logout</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- CONTENT -->
    <div class="container py-4">
      <h2 class="fw-bold mb-4">‚úèÔ∏è Edit Pendaftaran Peserta</h2>

      <div class="card p-4 shadow">
        <form id="formEditPendaftaran" enctype="multipart/form-data">
          <input type="hidden" id="edit_id_pendaftaran" />

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">Nama Peserta *</label>
              <input
                type="text"
                id="edit_nama_peserta"
                name="nama_peserta"
                class="form-control"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Pelatihan</label>
              <input
                type="text"
                id="edit_pelatihan"
                class="form-control"
                disabled
              />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">NIK *</label>
              <input
                type="text"
                id="edit_nik"
                name="nik"
                class="form-control"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">NIP *</label>
              <input
                type="text"
                id="edit_nip"
                name="nip"
                class="form-control"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Jenis Kelamin *</label>
              <select
                id="edit_jenis_kelamin"
                name="jenis_kelamin"
                class="form-control"
                readonly
              >
                <option value="Pria">Pria</option>
                <option value="Wanita">Wanita</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Profesi</label>
              <input
                type="text"
                id="edit_profesi"
                name="profesi"
                class="form-control"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">No. WhatsApp *</label>
              <input
                type="text"
                id="edit_no_wa"
                name="no_wa"
                class="form-control"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Status *</label>
              <select id="edit_status" name="status" class="form-control">
                <option value="Menunggu Verifikasi Berkas">
                  Menunggu Verifikasi Berkas
                </option>
                <option value="Verifikasi Berkas Invalid">
                  Verifikasi Berkas Invalid
                </option>
                <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                <option value="Verifikasi Pembayaran Invalid">
                  Verifikasi Pembayaran Invalid
                </option>
                <option value="Diterima">Diterima</option>
                <option value="Selesai">Selesai</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Email *</label>
              <input
                type="email"
                id="edit_email"
                name="email"
                class="form-control"
                readonly
              />
            </div>

            <!-- SURAT TUGAS -->
            <div class="col-md-6">
              <label class="form-label fw-bold"
                >Upload Surat Tugas (PDF/JPG/PNG)</label
              >
              <input
                type="file"
                id="edit_surat_tugas"
                name="surat_tugas"
                class="form-control"
                readonly
              />

              <div class="mt-2">
                <a
                  id="linkSurat"
                  href="#"
                  class="btn btn-sm btn-secondary"
                  target="_blank"
                  style="display: none"
                  readonly
                  >Lihat Surat</a
                >
              </div>
            </div>

            <!-- FOTO 4x6 -->
            <div class="col-md-6">
              <label class="form-label fw-bold">Upload Foto 4x6</label>
              <input
                type="file"
                id="edit_foto_4x6"
                name="foto_4x6"
                class="form-control"
                accept="image/*"
                readonly
              />

              <img
                id="previewFoto"
                class="thumb-img mt-2 border rounded"
                style="display: none; cursor: zoom-in"
                onclick="zoomFoto()"
              />
            </div>
          </div>

          <div class="text-end mt-4">
            <a href="pendaftaran.html" class="btn btn-secondary">Kembali</a>
            <button type="submit" class="btn btn-primary">
              Simpan Perubahan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL ZOOM FOTO -->
    <div class="modal fade" id="modalZoomFoto" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
          <img id="zoomFotoImage" class="img-fluid rounded shadow" />
        </div>
      </div>
    </div>

    <!-- JS -->
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const API = "http://localhost:5000/api/pendaftaran";

        // Ambil ID dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");

        if (!id) {
          alert("ID peserta tidak ditemukan.");
          window.location.href = "pendaftaran.html";
          return;
        }

        // ============================
        // NORMALIZE JENIS KELAMIN
        // ============================
        function normalizeJK(jk) {
          if (!jk) return "";

          const value = jk.toLowerCase().trim();

          if (["pria", "l", "laki-laki"].includes(value)) return "Pria";
          if (["wanita", "p", "perempuan"].includes(value)) return "Wanita";

          return "";
        }

        // ============================
        // LOAD DATA
        // ============================
        async function loadData() {
          const res = await fetch(API);
          const data = await res.json();

          const peserta = data.find((p) => p.id_pendaftaran == id);

          if (!peserta) {
            alert("Data tidak ditemukan.");
            window.location.href = "pendaftaran.html";
            return;
          }

          // Isi semua field form
          document.getElementById("edit_id_pendaftaran").value =
            peserta.id_pendaftaran;

          document.getElementById("edit_nama_peserta").value =
            peserta.nama_peserta;

          document.getElementById("edit_pelatihan").value =
            peserta.nama_pelatihan;

          document.getElementById("edit_nik").value = peserta.nik;
          document.getElementById("edit_nip").value = peserta.nip;

          document.getElementById("edit_jenis_kelamin").value = normalizeJK(
            peserta.jenis_kelamin
          );

          document.getElementById("edit_profesi").value = peserta.profesi ?? "";
          document.getElementById("edit_no_wa").value = peserta.no_wa;

          // üí° Tidak perlu normalizeStatus karena ENUM DB sudah rapi
          document.getElementById("edit_status").value = peserta.status;

          document.getElementById("edit_email").value = peserta.email;

          // Surat Tugas
          if (peserta.surat_tugas) {
            const linkSurat = document.getElementById("linkSurat");
            linkSurat.href = `http://localhost:5000/uploads/surat_tugas/${peserta.surat_tugas}`;
            linkSurat.style.display = "inline-block";
          }

          // Foto 4x6
          if (peserta.foto_4x6) {
            const preview = document.getElementById("previewFoto");
            preview.src = `http://localhost:5000/uploads/foto_4x6/${peserta.foto_4x6}`;
            preview.style.display = "block";
          }
        }

        await loadData();

        // ============================
        // SAVE UPDATE
        // ============================
        document
          .getElementById("formEditPendaftaran")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(
              document.getElementById("formEditPendaftaran")
            );

            const updateRes = await fetch(`${API}/${id}`, {
              method: "PUT",
              body: formData,
            });

            const result = await updateRes.json();
            alert(result.message);

            window.location.href = "pendaftaran.html";
          });
      });

      // ZOOM FOTO
      function zoomFoto() {
        const imgSrc = document.getElementById("previewFoto").src;
        if (!imgSrc) return;

        document.getElementById("zoomFotoImage").src = imgSrc;
        new bootstrap.Modal(document.getElementById("modalZoomFoto")).show();
      }
    </script>

    <script src="http://localhost:5000/static/admin_check.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

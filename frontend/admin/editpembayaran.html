<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Edit Pembayaran Peserta</title>

    <!-- PROTEKSI LOGIN ADMIN -->
    <script>
      const admin = localStorage.getItem("admin");
      if (!admin) {
        window.location.href = "loginadmin.html";
      }
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/main.css" />

    <style>
      body {
        background: #f5f6fa;
      }
      .card {
        border-radius: 10px;
      }
      .thumb-img {
        width: 120px;
        border-radius: 8px;
        cursor: zoom-in;
      }
    </style>
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">Admin DIKLAT</a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#adminNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </nav>

    <!-- CONTENT -->
    <div class="container py-4">
      <h2 class="fw-bold mb-4">✏️ Edit Pembayaran Peserta</h2>

      <div class="card p-4 shadow">
        <form id="formEditPembayaran" enctype="multipart/form-data">
          <input type="hidden" id="id_pembayaran" />

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">Nama Peserta</label>
              <input
                type="text"
                id="nama_peserta"
                class="form-control"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Pelatihan</label>
              <input
                type="text"
                id="nama_pelatihan"
                class="form-control"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Nomor WhatsApp</label>
              <input type="text" id="no_wa" class="form-control" readonly />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Status Pembayaran</label>
              <select id="status_bayar" class="form-control">
                <option value="PENDING">PENDING</option>
                <option value="VALID">VALID</option>
                <option value="INVALID">INVALID</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Bukti Pembayaran</label>
              <div id="view_bukti"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold"
                >Upload Bukti Pembayaran Baru</label
              >
              <input
                type="file"
                id="bukti_transfer"
                name="bukti"
                class="form-control"
                disabled
              />
            </div>
          </div>

          <div class="text-end mt-4">
            <a href="pembayaran.html" class="btn btn-secondary">Kembali</a>
            <button type="submit" class="btn btn-primary">
              Simpan Perubahan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- JS -->
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const API = "http://localhost:5000/api/pembayaran";

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");

        let idPendaftaran = null;

        if (!id) {
          alert("ID pembayaran tidak ditemukan.");
          window.location.href = "pembayaran.html";
          return;
        }

        // LOAD DATA PEMBAYARAN
        async function loadData() {
          const res = await fetch(`${API}`);
          const list = await res.json();

          const pembayaran = list.find((p) => p.id_pembayaran == id);

          if (!pembayaran) {
            alert("Pembayaran tidak ditemukan!");
            window.location.href = "pembayaran.html";
            return;
          }

          idPendaftaran = pembayaran.id_pendaftaran;

          document.getElementById("id_pembayaran").value =
            pembayaran.id_pembayaran;
          document.getElementById("nama_peserta").value =
            pembayaran.nama_peserta;
          document.getElementById("nama_pelatihan").value =
            pembayaran.nama_pelatihan;
          document.getElementById("no_wa").value = pembayaran.no_wa;
          document.getElementById("status_bayar").value =
            pembayaran.status_bayar;

          document.getElementById(
            "view_bukti"
          ).innerHTML = `<a href="http://localhost:5000/uploads/bukti_transfer/${pembayaran.bukti_transfer}" 
                target="_blank"><img src="http://localhost:5000/uploads/bukti_transfer/${pembayaran.bukti_transfer}" 
                class="thumb-img"></a>`;
        }

        await loadData();

        // UPDATE PEMBAYARAN
        document
          .getElementById("formEditPembayaran")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const status = document.getElementById("status_bayar").value;

            let pembayaranURL = "";
            let pendaftaranURL = "";

            // VALID
            if (status === "VALID") {
              pembayaranURL = `${API}/${id}/validate`;
              pendaftaranURL = `http://localhost:5000/api/pendaftaran/${idPendaftaran }/payment-valid`;
            }

            // INVALID
            else if (status === "INVALID") {
              pembayaranURL = `${API}/${id}/invalid`;
              pendaftaranURL = `http://localhost:5000/api/pendaftaran/${idPendaftaran }/payment-invalid`;
            }

            // PENDING
            else if (status === "PENDING") {
              pembayaranURL = `${API}/${id}/pending`;
              // status pendaftaran tidak berubah kalau pending
            }

            // EXECUTE UPDATE PEMBAYARAN
            const res = await fetch(pembayaranURL, { method: "PUT" });
            const result = await res.json();
            alert(result.message);

            // UPDATE PENDAFTARAN (hanya VALID/INVALID)
            if (status === "VALID" || status === "INVALID") {
              await fetch(pendaftaranURL, { method: "PUT" });
            }

            window.location.href = "pembayaran.html";
          });
      });
    </script>
    <script src="http://localhost:5000/static/admin_check.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
